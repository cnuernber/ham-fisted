<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>ham-fisted.reduce documentation</title><script async="true" src="https://www.googletagmanager.com/gtag/js?id=G-XJYNJF48RM"></script><script>window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-XJYNJF48RM');</script><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="highlight/solarized-light.css" /><script type="text/javascript" src="highlight/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a> with <a href="https://github.com/xsc/codox-theme-rdash">RDash UI</a> theme</h2><h1><a href="index.html"><span class="project-title"><span class="project-name">Ham-Fisted</span> <span class="project-version">3.002</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Topics</span></h3><ul><li class="depth-1 "><a href="Reductions.html"><div class="inner"><span>Reductions</span></div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>ham-fisted</span></div></div></li><li class="depth-2 branch"><a href="ham-fisted.api.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>api</span></div></a></li><li class="depth-2 branch"><a href="ham-fisted.bloom-filter.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>bloom-filter</span></div></a></li><li class="depth-2 branch"><a href="ham-fisted.defprotocol.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>defprotocol</span></div></a></li><li class="depth-2 branch"><a href="ham-fisted.function.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>function</span></div></a></li><li class="depth-2 branch"><a href="ham-fisted.hlet.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>hlet</span></div></a></li><li class="depth-2 branch"><a href="ham-fisted.iterator.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>iterator</span></div></a></li><li class="depth-2 branch"><a href="ham-fisted.lazy-noncaching.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>lazy-noncaching</span></div></a></li><li class="depth-2 branch"><a href="ham-fisted.mut-map.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>mut-map</span></div></a></li><li class="depth-2 branch"><a href="ham-fisted.primitive-invoke.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>primitive-invoke</span></div></a></li><li class="depth-2 branch"><a href="ham-fisted.protocols.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>protocols</span></div></a></li><li class="depth-2 branch current"><a href="ham-fisted.reduce.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>reduce</span></div></a></li><li class="depth-2"><a href="ham-fisted.set.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>set</span></div></a></li></ul></div><div class="sidebar secondary"><h3><a href="#top"><span class="inner">Public Vars</span></a></h3><ul><li class="depth-1"><a href="ham-fisted.reduce.html#var--.3Econsumer"><div class="inner"><span>-&gt;consumer</span></div></a></li><li class="depth-1"><a href="ham-fisted.reduce.html#var-bind-double-consumer-reducer.21"><div class="inner"><span>bind-double-consumer-reducer!</span></div></a></li><li class="depth-1"><a href="ham-fisted.reduce.html#var-compose-reducers"><div class="inner"><span>compose-reducers</span></div></a></li><li class="depth-1"><a href="ham-fisted.reduce.html#var-consume.21"><div class="inner"><span>consume!</span></div></a></li><li class="depth-1"><a href="ham-fisted.reduce.html#var-consumer-accumulator"><div class="inner"><span>consumer-accumulator</span></div></a></li><li class="depth-1"><a href="ham-fisted.reduce.html#var-consumer-preducer"><div class="inner"><span>consumer-preducer</span></div></a></li><li class="depth-1"><a href="ham-fisted.reduce.html#var-consumer-reducer"><div class="inner"><span>consumer-reducer</span></div></a></li><li class="depth-1"><a href="ham-fisted.reduce.html#var-double-accumulator"><div class="inner"><span>double-accumulator</span></div></a></li><li class="depth-1"><a href="ham-fisted.reduce.html#var-double-consumer-accumulator"><div class="inner"><span>double-consumer-accumulator</span></div></a></li><li class="depth-1"><a href="ham-fisted.reduce.html#var-double-consumer-preducer"><div class="inner"><span>double-consumer-preducer</span></div></a></li><li class="depth-1"><a href="ham-fisted.reduce.html#var-double-consumer-reducer"><div class="inner"><span>double-consumer-reducer</span></div></a></li><li class="depth-1"><a href="ham-fisted.reduce.html#var-immut-map-kv"><div class="inner"><span>immut-map-kv</span></div></a></li><li class="depth-1"><a href="ham-fisted.reduce.html#var-indexed-accum"><div class="inner"><span>indexed-accum</span></div></a></li><li class="depth-1"><a href="ham-fisted.reduce.html#var-indexed-double-accum"><div class="inner"><span>indexed-double-accum</span></div></a></li><li class="depth-1"><a href="ham-fisted.reduce.html#var-indexed-long-accum"><div class="inner"><span>indexed-long-accum</span></div></a></li><li class="depth-1"><a href="ham-fisted.reduce.html#var-long-accumulator"><div class="inner"><span>long-accumulator</span></div></a></li><li class="depth-1"><a href="ham-fisted.reduce.html#var-long-consumer-accumulator"><div class="inner"><span>long-consumer-accumulator</span></div></a></li><li class="depth-1"><a href="ham-fisted.reduce.html#var-long-consumer-reducer"><div class="inner"><span>long-consumer-reducer</span></div></a></li><li class="depth-1"><a href="ham-fisted.reduce.html#var-options-.3Eparallel-options"><div class="inner"><span>options-&gt;parallel-options</span></div></a></li><li class="depth-1"><a href="ham-fisted.reduce.html#var-parallel-reducer"><div class="inner"><span>parallel-reducer</span></div></a></li><li class="depth-1"><a href="ham-fisted.reduce.html#var-preduce"><div class="inner"><span>preduce</span></div></a></li><li class="depth-1"><a href="ham-fisted.reduce.html#var-preduce-reducer"><div class="inner"><span>preduce-reducer</span></div></a></li><li class="depth-1"><a href="ham-fisted.reduce.html#var-preduce-reducers"><div class="inner"><span>preduce-reducers</span></div></a></li><li class="depth-1"><a href="ham-fisted.reduce.html#var-reduce-reducer"><div class="inner"><span>reduce-reducer</span></div></a></li><li class="depth-1"><a href="ham-fisted.reduce.html#var-reduce-reducers"><div class="inner"><span>reduce-reducers</span></div></a></li><li class="depth-1"><a href="ham-fisted.reduce.html#var-reducer-.3Ecompletef"><div class="inner"><span>reducer-&gt;completef</span></div></a></li><li class="depth-1"><a href="ham-fisted.reduce.html#var-reducer-.3Erf"><div class="inner"><span>reducer-&gt;rf</span></div></a></li><li class="depth-1"><a href="ham-fisted.reduce.html#var-reducer-with-finalize"><div class="inner"><span>reducer-with-finalize</span></div></a></li><li class="depth-1"><a href="ham-fisted.reduce.html#var-reducer-xform-.3Ereducer"><div class="inner"><span>reducer-xform-&gt;reducer</span></div></a></li><li class="depth-1"><a href="ham-fisted.reduce.html#var-reducible-merge"><div class="inner"><span>reducible-merge</span></div></a></li></ul></div><div class="namespace-docs" id="content"><h1 class="anchor" id="top">ham-fisted.reduce</h1><div class="doc"><div class="markdown"><p>Protocol-based parallel reduction architecture and helper functions.</p>
</div></div><div class="public anchor" id="var--.3Econsumer"><h3>-&gt;consumer</h3><div class="usage"><code>(-&gt;consumer cfn)</code></div><div class="doc"><div class="markdown"><p>Return an instance of a consumer, double consumer, or long consumer.</p>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/ham-fisted/blob/master/src/ham_fisted/reduce.clj#L474">view source</a></div></div><div class="public anchor" id="var-bind-double-consumer-reducer.21"><h3>bind-double-consumer-reducer!</h3><div class="usage"><code>(bind-double-consumer-reducer! cls-type ctor)</code><code>(bind-double-consumer-reducer! ctor)</code></div><div class="doc"><div class="markdown"><p>Bind a classtype as a double consumer parallel reducer - the consumer must implement
DoubleConsumer, ham_fisted.Reducible, and IDeref.</p>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/ham-fisted/blob/master/src/ham_fisted/reduce.clj#L660">view source</a></div></div><div class="public anchor" id="var-compose-reducers"><h3>compose-reducers</h3><div class="usage"><code>(compose-reducers reducers)</code><code>(compose-reducers options reducers)</code></div><div class="doc"><div class="markdown"><p>Given a map or sequence of reducers return a new reducer that produces a map or
vector of results.</p>
<p>If data is a sequence then context is guaranteed to be an object array.</p>
<p>Options:</p>
<ul>
<li><code>:rfn-datatype</code> - One of nil, :int64, or :float64.  This indicates that the rfn's
should all be uniform as accepting longs, doubles, or generically objects.  Defaults
to nil.</li>
</ul>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/ham-fisted/blob/master/src/ham_fisted/reduce.clj#L203">view source</a></div></div><div class="public anchor" id="var-consume.21"><h3>consume!</h3><div class="usage"><code>(consume! consumer coll)</code></div><div class="doc"><div class="markdown"><p>Consumer a collection.  This is simply a reduction where the return value
is ignored.</p>
<p>Returns the consumer.</p>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/ham-fisted/blob/master/src/ham_fisted/reduce.clj#L490">view source</a></div></div><div class="public anchor" id="var-consumer-accumulator"><h3>consumer-accumulator</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>Generic reduction function using a consumer</p>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/ham-fisted/blob/master/src/ham_fisted/reduce.clj#L411">view source</a></div></div><div class="public anchor" id="var-consumer-preducer"><h3>consumer-preducer</h3><div class="usage"><code>(consumer-preducer constructor)</code></div><div class="doc"><div class="markdown"><p>Bind a consumer as a parallel reducer.</p>
<p>Consumer must implement java.util.function.Consumer,
ham_fisted.Reducible and clojure.lang.IDeref.</p>
<p>Returns instance of type bound.</p>
<p>See documentation for <a href="declare-double-consumer-preducer!">declare-double-consumer-preducer!</a>.</p>
<pre><code></code></pre>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/ham-fisted/blob/master/src/ham_fisted/reduce.clj#L638">view source</a></div></div><div class="public anchor" id="var-consumer-reducer"><h3>consumer-reducer</h3><div class="usage"><code>(consumer-reducer ctor)</code></div><div class="doc"><div class="markdown"><p>Make a parallel double consumer reducer given a function that takes no arguments and is
guaranteed to produce a double consumer which also implements Reducible and IDeref</p>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/ham-fisted/blob/master/src/ham_fisted/reduce.clj#L706">view source</a></div></div><div class="public anchor" id="var-double-accumulator"><h3>double-accumulator</h3><h4 class="type">macro</h4><div class="usage"><code>(double-accumulator accvar varvar &amp; code)</code></div><div class="doc"><div class="markdown"><p>Type-hinted double reduction accumulator.
consumer:</p>
<pre><code class="language-clojure">  ham-fisted.api&gt; (reduce (double-accumulator acc v (+ (double acc) v))
                             0.0
                             (range 1000))
#&lt;SimpleSum@2fbcf20: 499500.0&gt;
ham-fisted.api&gt; @*1
499500.0
</code></pre>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/ham-fisted/blob/master/src/ham_fisted/reduce.clj#L151">view source</a></div></div><div class="public anchor" id="var-double-consumer-accumulator"><h3>double-consumer-accumulator</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>Converts from a double consumer to a double reduction accumulator that returns the
consumer:</p>
<pre><code class="language-clojure">ham-fisted.api&gt; (reduce double-consumer-accumulator
                             (Sum$SimpleSum.)
                             (range 1000))
#&lt;SimpleSum@2fbcf20: 499500.0&gt;
ham-fisted.api&gt; @*1
499500.0
</code></pre>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/ham-fisted/blob/master/src/ham_fisted/reduce.clj#L382">view source</a></div></div><div class="public anchor" id="var-double-consumer-preducer"><h3>double-consumer-preducer</h3><div class="usage"><code>(double-consumer-preducer constructor)</code></div><div class="doc"><div class="markdown"><p>Return a preducer for a double consumer.</p>
<p>Consumer must implement java.util.function.DoubleConsumer,
ham_fisted.Reducible and clojure.lang.IDeref.</p>
<pre><code class="language-clojure">user&gt; (require '[ham-fisted.api :as hamf])
nil
user&gt; (import '[java.util.function DoubleConsumer])
java.util.function.DoubleConsumer
user&gt; (import [ham_fisted Reducible])
ham_fisted.Reducible
user&gt; (import '[clojure.lang IDeref])
clojure.lang.IDeref
user&gt; (deftype MeanR [^{:unsynchronized-mutable true :tag 'double} sum
                      ^{:unsynchronized-mutable true :tag 'long} n-elems]
        DoubleConsumer
        (accept [this v] (set! sum (+ sum v)) (set! n-elems (unchecked-inc n-elems)))
        Reducible
        (reduce [this o]
          (set! sum (+ sum (.-sum ^MeanR o)))
          (set! n-elems (+ n-elems (.-n-elems ^MeanR o)))
          this)
        IDeref (deref [this] (/ sum n-elems)))
user.MeanR
user&gt; (hamf/declare-double-consumer-preducer! MeanR (MeanR. 0 0))
nil
  user&gt; (hamf/preduce-reducer (double-consumer-preducer #(MeanR. 0 0)) (hamf/range 200000))
99999.5
</code></pre>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/ham-fisted/blob/master/src/ham_fisted/reduce.clj#L507">view source</a></div></div><div class="public anchor" id="var-double-consumer-reducer"><h3>double-consumer-reducer</h3><div class="usage"><code>(double-consumer-reducer ctor)</code></div><div class="doc"><div class="markdown"><p>Make a parallel double consumer reducer given a function that takes no arguments and is
guaranteed to produce a double consumer which also implements Reducible and IDeref</p>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/ham-fisted/blob/master/src/ham_fisted/reduce.clj#L678">view source</a></div></div><div class="public anchor" id="var-immut-map-kv"><h3>immut-map-kv</h3><div class="usage"><code>(immut-map-kv keyfn valfn data)</code><code>(immut-map-kv ks vs)</code></div><div class="doc"><div class="markdown"></div></div><div class="src-link"><a href="https://github.com/cnuernber/ham-fisted/blob/master/src/ham_fisted/reduce.clj#L186">view source</a></div></div><div class="public anchor" id="var-indexed-accum"><h3>indexed-accum</h3><h4 class="type">macro</h4><div class="usage"><code>(indexed-accum accvar idxvar varvar &amp; code)</code></div><div class="doc"><div class="markdown"><p>Create an indexed accumulator that recieves and additional long index
during a reduction:</p>
<pre><code class="language-clojure">ham-fisted.api&gt; (reduce (indexed-accum
                         acc idx v (conj acc [idx v]))
                        []
                        (range 5))
[[0 0] [1 1] [2 2] [3 3] [4 4]]
</code></pre>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/ham-fisted/blob/master/src/ham_fisted/reduce.clj#L420">view source</a></div></div><div class="public anchor" id="var-indexed-double-accum"><h3>indexed-double-accum</h3><h4 class="type">macro</h4><div class="usage"><code>(indexed-double-accum accvar idxvar varvar &amp; code)</code></div><div class="doc"><div class="markdown"><p>Create an indexed double accumulator that recieves and additional long index
during a reduction:</p>
<pre><code class="language-clojure">ham-fisted.api&gt; (reduce (indexed-double-accum
                         acc idx v (conj acc [idx v]))
                        []
                        (range 5))
[[0 0.0] [1 1.0] [2 2.0] [3 3.0] [4 4.0]]
</code></pre>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/ham-fisted/blob/master/src/ham_fisted/reduce.clj#L438">view source</a></div></div><div class="public anchor" id="var-indexed-long-accum"><h3>indexed-long-accum</h3><h4 class="type">macro</h4><div class="usage"><code>(indexed-long-accum accvar idxvar varvar &amp; code)</code></div><div class="doc"><div class="markdown"><p>Create an indexed long accumulator that recieves and additional long index
during a reduction:</p>
<pre><code class="language-clojure">ham-fisted.api&gt; (reduce (indexed-long-accum
                         acc idx v (conj acc [idx v]))
                        []
                        (range 5))
[[0 0] [1 1] [2 2] [3 3] [4 4]]
</code></pre>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/ham-fisted/blob/master/src/ham_fisted/reduce.clj#L456">view source</a></div></div><div class="public anchor" id="var-long-accumulator"><h3>long-accumulator</h3><h4 class="type">macro</h4><div class="usage"><code>(long-accumulator accvar varvar &amp; code)</code></div><div class="doc"><div class="markdown"><p>Type-hinted double reduction accumulator.
consumer:</p>
<pre><code class="language-clojure">  ham-fisted.api&gt; (reduce (double-accumulator acc v (+ (double acc) v))
                             0.0
                             (range 1000))
#&lt;SimpleSum@2fbcf20: 499500.0&gt;
ham-fisted.api&gt; @*1
499500.0
</code></pre>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/ham-fisted/blob/master/src/ham_fisted/reduce.clj#L169">view source</a></div></div><div class="public anchor" id="var-long-consumer-accumulator"><h3>long-consumer-accumulator</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>Converts from a long consumer to a long reduction accumulator that returns the
consumer:</p>
<pre><code class="language-clojure">ham-fisted.api&gt; (reduce double-consumer-accumulator
                             (Sum$SimpleSum.)
                             (range 1000))
#&lt;SimpleSum@2fbcf20: 499500.0&gt;
ham-fisted.api&gt; @*1
499500.0
</code></pre>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/ham-fisted/blob/master/src/ham_fisted/reduce.clj#L396">view source</a></div></div><div class="public anchor" id="var-long-consumer-reducer"><h3>long-consumer-reducer</h3><div class="usage"><code>(long-consumer-reducer ctor)</code></div><div class="doc"><div class="markdown"><p>Make a parallel double consumer reducer given a function that takes no arguments and is
guaranteed to produce a double consumer which also implements Reducible and IDeref</p>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/ham-fisted/blob/master/src/ham_fisted/reduce.clj#L692">view source</a></div></div><div class="public anchor" id="var-options-.3Eparallel-options"><h3>options-&gt;parallel-options</h3><div class="usage"><code>(options-&gt;parallel-options options)</code></div><div class="doc"><div class="markdown"><p>Convert an options map to a parallel options object.</p>
<p>Options:</p>
<ul>
<li><code>:pool</code> - supply the forkjoinpool to use.</li>
<li><code>:max-batch-size</code> - Defaults to 64000, used for index-based  parallel pathways to control
the number size of each parallelized batch.</li>
<li><code>:ordered?</code> - When true process inputs and provide results in order.</li>
<li><code>:parallelism</code> - The amount of parallelism to expect.  Defaults to the number of threads
in the fork-join pool provided.</li>
<li><code>:cat-parallelism</code> - Either <code>:seq-wise</code> or <code>:elem-wise</code> - when parallelizing over a
concatenation of containers either parallelize each container meaning call preduce on each
container using many threads per container or use one thread per container - <code>seq-wise</code>.  Defaults
to <code>seq-wise</code> as this doesn't require each container itself to support parallelization but relies on
the sequence of containers to be long enough to saturate the processor.  Can also be set at time of
container construction - see <a href="ham-fisted.lazy-noncaching.html#var-concat-opts">lazy-noncaching/concat-opts</a>.</li>
<li><code>:put-timeout-ms</code> - The time to wait to put data into the queue.  This is a safety mechanism
so that if the processing system fails we don't just keep putting things into a queue.</li>
<li><code>:unmerged-result?</code> - Use with care.  For parallel reductions do not perform the merge step
but instead return the sequence of partially reduced results.</li>
<li><code>:n-lookahead</code> - How for to look ahead for pmap and upmap to add new jobs to the queue.  Defaults
to `(* 2 parallelism).</li>
</ul>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/ham-fisted/blob/master/src/ham_fisted/reduce.clj#L27">view source</a></div></div><div class="public anchor" id="var-parallel-reducer"><h3>parallel-reducer</h3><div class="usage"><code>(parallel-reducer init-fn rfn merge-fn fin-fn)</code><code>(parallel-reducer init-fn rfn merge-fn)</code></div><div class="doc"><div class="markdown"><p>Implement a parallel reducer by explicitly passing in the various required functions.</p>
<ul>
<li>'init-fn' - Takes no argumenst and returns a new accumulation target.</li>
<li>'rfn' - clojure rf function - takes two arguments, the accumulation target and a new value
and produces a new accumulation target.</li>
<li>'merge-fn' - Given two accumulation targets returns a new combined accumulation target.</li>
<li>'fin-fn' - optional - Given an accumulation target returns the desired final type.</li>
</ul>
<pre><code class="language-clojure">user&gt; (hamf-rf/preduce-reducer
       (hamf-rf/parallel-reducer
        hamf/mut-set
        #(do (.add ^java.util.Set %1 %2) %1)
        hamf/union
        hamf/sort)
       (lznc/map (fn ^long [^long v] (rem v 13)) (hamf/range 1000000)))
[0 1 2 3 4 5 6 7 8 9 10 11 12]
</code></pre>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/ham-fisted/blob/master/src/ham_fisted/reduce.clj#L587">view source</a></div></div><div class="public anchor" id="var-preduce"><h3>preduce</h3><div class="usage"><code>(preduce init-val-fn rfn merge-fn coll)</code><code>(preduce init-val-fn rfn merge-fn options coll)</code></div><div class="doc"><div class="markdown"><p>Parallelized reduction.  Currently coll must either be random access or a lznc map/filter
chain based on one or more random access entities, hashmaps and sets from this library or
any java.util set, hashmap or concurrent versions of these.  If input cannot be
parallelized this lowers to a normal serial reduction.</p>
<p>For potentially small-n invocations providing the parallel options explicitly will improve
performance surprisingly - converting the options map to the parallel options object
takes a bit of time.</p>
<ul>
<li><code>init-val-fn</code> - Potentially called in reduction threads to produce each initial value.</li>
<li><code>rfn</code> - normal clojure reduction function.  Typehinting the second argument to double
or long will sometimes produce a faster reduction.</li>
<li><code>merge-fn</code> - Merge two reduction results into one.</li>
</ul>
<p>Options:</p>
<ul>
<li><code>:pool</code> - The fork-join pool to use.  Defaults to common pool which assumes reduction is
cpu-bound.</li>
<li><code>:parallelism</code> - What parallelism to use - defaults to pool's <code>getParallelism</code> method.</li>
<li><code>:max-batch-size</code> - Rough maximum batch size for indexed or grouped reductions.  This
can both even out batch times and ensure you don't get into safepoint trouble with
jdk-8.</li>
<li><code>:min-n</code> - minimum number of elements before initiating a parallelized reduction -
Defaults to 1000 but you should customize this particular to your specific reduction.</li>
<li><code>:ordered?</code> - True if results should be in order.  Unordered results sometimes are
slightly faster but again you should test for your specific situation..</li>
<li><code>:cat-parallelism</code> - Either <code>:seq-wise</code> or <code>:elem-wise</code>, defaults to <code>:seq-wise</code>.
Test for your specific situation, this really is data-dependent. This contols how a
concat primitive parallelizes the reduction across its contains.  Elemwise means each
container's reduction is individually parallelized while seqwise indicates to do a
pmap style initial reduction across containers then merge the results.</li>
<li><code>:put-timeout-ms</code> - Number of milliseconds to wait for queue space before throwing
an exception in unordered reductions.  Defaults to 50000.</li>
<li><code>:unmerged-result?</code> - Defaults to false.  When true, the sequence of results
be returned directly without any merge steps in a lazy-noncaching container.  Beware
the noncaching aspect -- repeatedly evaluating this result may kick off the parallelized
reduction multiple times.  To ensure caching if unsure call <code>seq</code> on the result.</li>
</ul>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/ham-fisted/blob/master/src/ham_fisted/reduce.clj#L75">view source</a></div></div><div class="public anchor" id="var-preduce-reducer"><h3>preduce-reducer</h3><div class="usage"><code>(preduce-reducer reducer options coll)</code><code>(preduce-reducer reducer coll)</code></div><div class="doc"><div class="markdown"><p>Given an instance of <a href="ham-fisted.protocols.html#var-ParallelReducer">ham-fisted.protocols/ParallelReducer</a>, perform a parallel
reduction.</p>
<p>In the case where the result is requested unmerged then finalize will
be called on each result in a lazy noncaching way.  In this case you can use a
non-parallelized reducer and simply get a sequence of results as opposed to one.</p>
<ul>
<li>reducer - instance of ParallelReducer</li>
<li>options - Same options as preduce.</li>
<li>coll - something potentially with a parallelizable reduction.</li>
</ul>
<p>See options for <a href="ham-fisted.reduce.html#var-preduce">ham-fisted.reduce/preduce</a>.</p>
<p>Additional Options:</p>
<ul>
<li><code>:skip-finalize?</code> - when true, the reducer's finalize method is not called on the result.</li>
</ul>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/ham-fisted/blob/master/src/ham_fisted/reduce.clj#L119">view source</a></div></div><div class="public anchor" id="var-preduce-reducers"><h3>preduce-reducers</h3><div class="usage"><code>(preduce-reducers reducers options coll)</code><code>(preduce-reducers reducers coll)</code></div><div class="doc"><div class="markdown"><p>Given a map or sequence of <a href="ham-fisted.protocols.html#var-ParallelReducer">ham-fisted.protocols/ParallelReducer</a>, produce a map or
sequence of reduced values. Reduces over input coll once in parallel if coll is large
enough.  See options for <a href="ham-fisted.reduce.html#var-preduce">ham-fisted.reduce/preduce</a>.</p>
<pre><code class="language-clojure">ham-fisted.api&gt; (preduce-reducers {:sum (Sum.) :mult *} (range 20))
{:mult 0, :sum #&lt;Sum@5082c3b7: {:sum 190.0, :n-elems 20}&gt;}
</code></pre>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/ham-fisted/blob/master/src/ham_fisted/reduce.clj#L259">view source</a></div></div><div class="public anchor" id="var-reduce-reducer"><h3>reduce-reducer</h3><div class="usage"><code>(reduce-reducer reducer coll)</code></div><div class="doc"><div class="markdown"><p>Serially reduce a reducer.</p>
<pre><code class="language-clojure">ham-fisted.api&gt; (reduce-reducer (Sum.) (range 1000))
#&lt;Sum@afbedb: {:sum 499500.0, :n-elems 1000}&gt;
</code></pre>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/ham-fisted/blob/master/src/ham_fisted/reduce.clj#L349">view source</a></div></div><div class="public anchor" id="var-reduce-reducers"><h3>reduce-reducers</h3><div class="usage"><code>(reduce-reducers reducers coll)</code></div><div class="doc"><div class="markdown"><p>Serially reduce a map or sequence of reducers into a map or sequence of results.</p>
<pre><code class="language-clojure">ham-fisted.api&gt; (reduce-reducers {:a (Sum.) :b *} (range 1 21))
{:b 2432902008176640000, :a #&lt;Sum@6bcebeb1: {:sum 210.0, :n-elems 20}&gt;}
</code></pre>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/ham-fisted/blob/master/src/ham_fisted/reduce.clj#L363">view source</a></div></div><div class="public anchor" id="var-reducer-.3Ecompletef"><h3>reducer-&gt;completef</h3><div class="usage"><code>(reducer-&gt;completef reducer)</code></div><div class="doc"><div class="markdown"><p>Return fold-compatible pair of <a href="reducef, completef">reducef, completef</a> given a parallel reducer.
Note that folded reducers are not finalized as of this time:</p>
<pre><code class="language-clojure">ham-fisted.api&gt; (def data (vec (range 200000)))
#'ham-fisted.api/data
ham-fisted.api&gt; (r/fold (reducer-&gt;completef (Sum.)) (reducer-&gt;rfn (Sum.)) data)
#&lt;Sum@858c206: {:sum 1.99999E10, :n-elems 200000}&gt;
</code></pre>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/ham-fisted/blob/master/src/ham_fisted/reduce.clj#L317">view source</a></div></div><div class="public anchor" id="var-reducer-.3Erf"><h3>reducer-&gt;rf</h3><div class="usage"><code>(reducer-&gt;rf reducer)</code></div><div class="doc"><div class="markdown"><p>Given a reducer, return a transduce-compatible rf -</p>
<pre><code class="language-clojure">ham-fisted.api&gt; (transduce (clojure.core/map #(+ % 2)) (reducer-&gt;rf (Sum.)) (range 200))
{:sum 20300.0, :n-elems 200}
</code></pre>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/ham-fisted/blob/master/src/ham_fisted/reduce.clj#L301">view source</a></div></div><div class="public anchor" id="var-reducer-with-finalize"><h3>reducer-with-finalize</h3><div class="usage"><code>(reducer-with-finalize reducer fin-fn)</code></div><div class="doc"><div class="markdown"></div></div><div class="src-link"><a href="https://github.com/cnuernber/ham-fisted/blob/master/src/ham_fisted/reduce.clj#L337">view source</a></div></div><div class="public anchor" id="var-reducer-xform-.3Ereducer"><h3>reducer-xform-&gt;reducer</h3><div class="usage"><code>(reducer-xform-&gt;reducer reducer xform)</code></div><div class="doc"><div class="markdown"><p>Given a reducer and a transducer xform produce a new reducer which will apply
the transducer pipeline before is reduction function.</p>
<pre><code class="language-clojure">ham-fisted.api&gt; (reduce-reducer (reducer-xform-&gt;reducer (Sum.) (clojure.core/filter even?))
                                (range 1000))
#&lt;Sum@479456: {:sum 249500.0, :n-elems 500}&gt;
</code></pre>
<p>!! - If you use a stateful transducer here then you must <em>not</em> use the reducer in a
parallelized reduction.</p>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/ham-fisted/blob/master/src/ham_fisted/reduce.clj#L273">view source</a></div></div><div class="public anchor" id="var-reducible-merge"><h3>reducible-merge</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>Parallel reduction merge function that expects both sides to be an instances of
Reducible</p>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/ham-fisted/blob/master/src/ham_fisted/reduce.clj#L416">view source</a></div></div></div></body></html>